before_script:
  - cd mwa
  
cache:
  key: modules
  paths:
    - $HOME/go/pkg/mod

stages:
  - build
  - test
  - deploy
  
.job_template: &azure_upload_file
  stage: deploy
  image: microsoft/azure-cli
  script:
      - az login --service-principal -u https://deployment.rimote.net -p /keys/azure.pem --tenant $AZURETENANT
      - az storage blob upload -f $AZURE_INPUT_FILE -n $AZURE_OUTPUT_FILE -c $AZURE_STORAGE_CONTAINER

.job_template: &go_test
  stage: test
  image: golang:1.11
  script:
      - go test -v ./...
  
.job_template: &go_build  # Hidden key that defines an anchor named 'job_definition'
  stage: build
  image: golang:1.11
  script:
      - echo $LDFLAGS
      - go build
      - ls -l $GOPATH/pkg/mod
  artifacts:
      paths:
        - ${OUTPUT}

build-linux-arm:
  <<: *go_build
  variables:
    LDFLAGS: "-s -w -X main.GitCommit=${CI_COMMIT_SHA} -X main.Version=${CI_COMMIT_TAG}"
    GOOS: linux
    GOARCH: arm
    GOARM: 7
    OUTPUT: mwa/mwa
    
build-linux-amd64:
  <<: *go_build
  variables:
    LDFLAGS: "-X main.GitCommit=${CI_COMMIT_SHA} -X main.Version=${CI_COMMIT_TAG}"
    GOOS: linux
    GOARCH: amd64
    OUTPUT: mwa/mwa
    
build-win-amd64:
  <<: *go_build
  variables:
    LDFLAGS: "-X main.GitCommit=${CI_COMMIT_SHA} -X main.Version=${CI_COMMIT_TAG}"
    GOOS: windows
    GOARCH: amd64
    OUTPUT: mwa/mwa.exe
    
test-linux-amd64:
  <<: *go_test
  variables:
    GOOS: linux
    GOARCH: amd64
    
deploy-linux-arm:
  dependencies:
    - build-linux-arm
  <<: *azure_upload_file
  variables: 
    AZURE_INPUT_FILE: mwa
    AZURE_OUTPUT_FILE: mwa-arm
    AZURE_STORAGE_ACCOUNT: rimotedeployment
    AZURE_STORAGE_ACCESS_KEY: $AZURESECRETACCESKEY
    AZURE_STORAGE_CONTAINER: downloads
    
  
    